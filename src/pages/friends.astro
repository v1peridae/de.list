---
import "../styles/global.css";
import Header from "../components/Header.astro";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>de.list</title>
  </head>
  <body class="flex flex-col items-center min-h-screen bg-[#feebf6]">
    <Header />

    <div class="w-full max-w-4xl px-4 mt-16">
      <div class="flex gap-8">
        <div class="w-2/3">
          <h2 class="title text-3xl mb-6">your friends</h2>
          <div class="friends-list space-y-4">
            <div>
              <h3 class="subtitle text-xl">@everyone_2_swag</h3>
            </div>
          </div>
        </div>

        <div class="w-1/3">
          <h2 class="title text-3xl mb-4 text-center">add friend</h2>
          <div class="flex flex-col items-center gap-4">
            <p class="subtitle text-lg opacity-75 text-left">enter your friend's 6-digit code:</p>
            <div class="flex gap-2">
              <input type="text" maxlength="1" class="w-10 h-12 bg-transparent border-b-2 border-[#687fe5] text-2xl text-center subtitle" />
              <input type="text" maxlength="1" class="w-10 h-12 bg-transparent border-b-2 border-[#687fe5] text-2xl text-center subtitle" />
              <input type="text" maxlength="1" class="w-10 h-12 bg-transparent border-b-2 border-[#687fe5] text-2xl text-center subtitle" />
              <input type="text" maxlength="1" class="w-10 h-12 bg-transparent border-b-2 border-[#687fe5] text-2xl text-center subtitle" />
              <input type="text" maxlength="1" class="w-10 h-12 bg-transparent border-b-2 border-[#687fe5] text-2xl text-center subtitle" />
              <input type="text" maxlength="1" class="w-10 h-12 bg-transparent border-b-2 border-[#687fe5] text-2xl text-center subtitle" />
            </div>
            <button id="addFriendBtn" class="button text-xl underline mt-4"> Add Friend </button>
          </div>

          <div class="mt-8 pt-6 border-t border-[#687fe5] border-opacity-30">
            <div class="flex flex-col items-center gap-3">
              <p class="subtitle text-lg opacity-75">your friend code:</p>
              <div class="bg-[#687fe5] bg-opacity-10 px-6 py-3 rounded-lg">
                <span id="userFriendCode" class="subtitle text-2xl font-mono tracking-wider">------</span>
              </div>
              <p class="text-sm opacity-60 text-center">share this code with friends so they can add you</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      import { initAuthGuard, addLogoutFunctionality } from "../utils/authGuard";

      initAuthGuard().then((user) => {
        if (user) {
          console.log("User authenticated:", user.email);
          addLogoutFunctionality();
          loadUserFriendCode();
        }
      });

      const codeInputs = document.querySelectorAll('input[type="text"]') as NodeListOf<HTMLInputElement>;
      const addFriendBtn = document.getElementById("addFriendBtn");

      codeInputs.forEach((input, index) => {
        input.addEventListener("input", (e) => {
          const target = e.target as HTMLInputElement;
          target.value = target.value.replace(/[^0-9]/g, "");

          if (target.value && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
          }
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !input.value && index > 0) {
            codeInputs[index - 1].focus();
          }
        });
      });

      addFriendBtn?.addEventListener("click", () => {
        const code = Array.from(codeInputs)
          .map((input) => input.value)
          .join("");
        if (code.length === 6) {
          console.log("Friend code:", code);
        }
      });

      async function loadUserFriendCode() {
        try {
          const { getAuth } = await import("firebase/auth");
          const auth = getAuth();
          const user = auth.currentUser;

          if (!user) return;

          const token = await user.getIdToken();
          const response = await fetch("/api/friends?action=my-code", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            const friendCodeElement = document.getElementById("userFriendCode");
            if (friendCodeElement) {
              friendCodeElement.textContent = data.friendCode;
            }
          }
        } catch (error) {
          console.error("Error loading friend code:", error);
        }
      }
    </script>
  </body>
</html>
